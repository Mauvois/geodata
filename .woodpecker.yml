when:
  event: [push, manual]
  branch: [main, dev]

steps:
  build:
    image: python:3.11
    commands:
      - pip install -r requirements.txt
      - echo "✅ Linting & Tests à venir ici"

  dockerize:
    image: plugins/docker
    settings:
      dockerfile: Dockerfile
      repo: geodata_api
      tags: latest

  deploy-prod:
    image: docker/compose:1.29.2
    commands:
      - docker-compose -f docker-compose.prod.yml up -d --build
    environment:
      DB_HOST:
        from_secret: DB_HOST
      DB_PORT:
        from_secret: DB_PORT
      DB_USER:
        from_secret: DB_USER
      DB_PASSWORD:
        from_secret: DB_PASSWORD
      DB_NAME:
        from_secret: DB_NAME
    when:
      branch: [main]
      event: [push, manual]

  deploy-staging:
    image: docker/compose:1.29.2
    commands:
      - docker-compose -f docker-compose.staging.yml up -d --build
    environment:
      DB_HOST:
        from_secret: DB_HOST
      DB_PORT:
        from_secret: DB_PORT
      DB_USER:
        from_secret: DB_USER
      DB_PASSWORD:
        from_secret: DB_PASSWORD
      DB_NAME:
        from_secret: DB_NAME
    when:
      branch: [dev]
      event: [push, manual]
